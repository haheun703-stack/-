# 자동매매봇 최종 검수 결과

**검수일**: 2026-02-28
**검수 대상**: 포물선의 시작점 v10.3 + JARVIS 시스템
**검수 수행**: Claude Opus 4.6 (코드 기반 정적 분석)

---

## 검수 결과 총괄

| 영역 | Pass | Conditional | Fail | N/A | 합계 |
|------|------|-------------|------|-----|------|
| 2. 트레이딩 로직 | 12 | 3 | 0 | 0 | 15 |
| 3. 슬리피지/체결 | 4 | 0 | 1 | 4 | 9 |
| 4. 데이터 무결성 | 12 | 0 | 1 | 0 | 13 |
| 5. 시스템 안정성 | 5 | 3 | 4 | 0 | 12 |
| **합계** | **33** | **6** | **6** | **4** | **49** |

**판정: 조건부 GO** — Critical 2건 수정 완료, Fail 6건은 운영 중 순차 개선

---

## 영역별 상세 결과

### 2.1 시그널 생성 로직 (5/5 Pass)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | 진입 조건 정합성 | Pass | v8 Gate(G1/G2/G3)+Trigger(T1~T4) 코드가 settings.yaml과 일치. adx_min=14, max_52w_ratio=0.95 (v8.5 역도출 반영) |
| 2 | 청산 조건 정합성 | Pass | 5단계 청산: 최대보유일(20일)+절대손절+퍼센트손절+4단계부분청산(R2/4/8/10)+트레일링스탑(ATR*2) |
| 3 | 필터 조건 동작 | Pass | DART AVOID, 가격필터(80만원), 소스필터(3개+OR 2개+70점), AI거부권, 이벤트섹터중복제한 |
| 4 | 시그널 중복 방지 | Pass | used_tickers set으로 swing/short 간 중복 차단 |
| 5 | 멀티 타임프레임 | Pass | 일봉(parquet) vs 5분봉(KIS API) 독립 경로, 09:05 이후 봉만 필터 |

### 2.2 주문 실행 로직 (4 Pass + 1 Conditional)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | 매수/매도 방향 | Pass | BUY→buy_limit, 청산→sell_market/sell_limit. OrderSide enum 명시 구분 |
| 2 | 수량 계산 | Pass | int() 정수 절삭, max_amount 기반 상한, 최소 1주 보장 |
| 3 | 주문 유형 | Pass | SmartEntry 적응형 지정가(-0.5%→정정), 손절/긴급은 시장가 |
| 4 | 동시 주문 처리 | Conditional | 순차 for 루프로 경합 없음. asyncio 기술스택 설명과 실제 동기식 불일치 |
| 5 | 잔고 한도 체크 | Pass | 실잔고 조회→20% 유보→가용 잔고 계산→포트폴리오 리스크 한도 |

### 2.3 리스크 관리 (2 Pass + 3 Conditional)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | 일일 최대 손실 | Pass | -3% 한도 → SafetyGuard can_trade=False → 신규 매수 차단 |
| 2 | 최대 동시 포지션 | Pass | KOSPI 레짐 슬롯(0~5) → `_get_kospi_regime_slots()` → `execute_buy_signals()` 연결 완료 |
| 3 | 개별 종목 비중 | Pass | 계좌 40% 상한 + SmartEntry 종목당 100만원 절대 상한 |
| 4 | MDD 관리 | **Conditional** | **MDDMonitor 5단계 경고+알림 구현. 다만 danger(-6%)에서 자동 진입 차단 미연결** |
| 5 | 긴급 청산 Kill Switch | Pass | 3중: SafetyGuard(-10% 자동), KILL_SWITCH 파일, 텔레그램 /청산 명령 |

### 3.1 슬리피지 측정 (2 Pass + 1 Fail + 2 N/A)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | 시그널-체결 괴리 | N/A | dry_run=True, 실전 체결 이력 없음. order_audit.db 수집 인프라 준비됨 |
| 2 | 시간대별 분포 | N/A | 실전 데이터 없음 |
| 3 | 유동성별 슬리피지 | Pass | 동적 슬리피지 모델: 가격대별 역비례 스케일링 구현 |
| 4 | 백테스트 가정 적정성 | Pass | 0.1% 기본 + 동적 증가, 양방향 적용 |
| 5 | 대량 주문 영향도 | **Fail** | **거래량 대비 주문량 비율 기반 마켓 임팩트 모델 없음** |

### 3.2 체결 품질 (2 Pass + 2 N/A)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | 체결률 | N/A | dry_run 상태, 추적 DB 구조만 존재 |
| 2 | 부분 체결 처리 | Pass | OrderStatus.PARTIAL 인식 + apply_partial_exit() 구현 |
| 3 | 주문-체결 지연 | N/A | 5초 간격 조회, 5분 타임아웃 구현 |
| 4 | 호가 스프레드 | Pass | 10호가 조회 + 매수/매도 잔량 비율 분석 |

### 4.1 시세 데이터 수집 (5/5 Pass)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | API 연결 안정성 | Pass | mojito2 자동 토큰 관리 + Rate Limit 보호 (초당 16건) |
| 2 | 실시간 데이터 지연 | Pass | 일봉 기반, 거래소 공식 영업일 타임스탬프 |
| 3 | NaN/Null 처리 | Pass | OHLCV NaN 0건, 기술지표 warmup NaN은 pd.isna() 가드 |
| 4 | 장외시간 데이터 | Pass | 장중 153000 캡핑, 장전 090000 차단 |
| 5 | 종목코드 매핑 | Pass | 동적 유니버스 rebuild, 1,029종목, 1,027종목 최신 |

### 4.2 데이터 가공 및 저장 (4 Pass + 1 Fail)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | 지표 계산 정확성 | Pass | RSI(EWM/SMA 방식차 1.0), 볼린저밴드 0.00 오차, TRIX/ADX 정상 |
| 2 | 데이터 정렬 | Pass | 모든 샘플 오름차순, 중복 0건, close=0 없음 |
| 3 | 수정주가 반영 | Pass | pykrx adjusted=True, FDR 수정주가, 액면분할 확인 |
| 4 | DB 저장 무결성 | Pass | 1,027/1,029 최신, gap은 공휴일 정상 |
| 5 | 백업 및 복구 | **Fail** | **데이터 파일 Git 미포함, 별도 백업 시스템 없음. 로컬 디스크 단일본** |

### 4.3 데이터 일관성 (3/3 Pass)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | 봇 vs 외부 소스 | Pass | parquet/CSV 두 소스 완벽 일치 (삼성전자 216,500원) |
| 2 | 실시간 vs 일봉 | Pass | 일봉 전용 시스템, 실시간 혼입 없음 |
| 3 | 백테스트 vs 실전 | Pass | 동일 parquet 사용 |

### 5.1 안정성 테스트 (2 Pass + 1 Conditional + 2 Fail)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | 메모리 누수 | **Fail** | **메모리 모니터링/프로파일링 없음. BAT 방식으로 리스크 경감** |
| 2 | CPU 사용률 | Pass | sleep 기반 루프 + Rate limiting |
| 3 | 로그 적재 | Conditional | RotatingFileHandler 10MB×5 적용, BAT schedule.log는 무한 append |
| 4 | 프로세스 재시작 | **Fail** | **자가 재시작 없음. Task Scheduler만 의존, 중간 크래시 대응 불가** |
| 5 | 동시성 문제 | Pass | threading.RLock 보호, sync 기반 |

### 5.2 장애 시나리오 대응 (2 Conditional + 3 Fail)

| No | 항목 | 결과 | 비고 |
|----|------|------|------|
| 1 | API 연결 끊김 | Conditional | 3회 재시도 + API 실패 카운터. 토큰 재발급 명시 코드 없음 |
| 2 | 서버 재부팅 | Conditional | positions.json 영속화. 미체결 주문 동기화 미구현 |
| 3 | 데이터 피드 끊김 | **Fail** | **전용 감지 로직 없음. API 실패 카운터가 간접 대체** |
| 4 | 증권사 점검 | **Fail** | **점검 시간 인지 코드 없음. BAT 스케줄이 자연 회피** |
| 5 | 텔레그램 장애 | Pass | 1회 재시도 + `logs/emergency_alerts.log` 파일 폴백 + 긴급 알림 항상 파일 기록 |

---

## 핵심 발견 사항 (우선순위)

### Critical 수정 권고 (실전 전 해결 필요)

1. **KOSPI 레짐 캡 미연결** (2.3-2) — **수정 완료 (2026-02-28)**
   - ~~LiveTradingEngine.max_positions=5 하드코딩~~
   - 수정: `_get_kospi_regime_slots()` 메서드 추가, `execute_buy_signals()`에서 `min(max_positions, regime_slots)` 적용
   - 검증: 현재 KOSPI 레짐 CAUTION → 3슬롯 (설정 5에서 3으로 캡)

2. **텔레그램 대체 알림 없음** (5.2-5) — **수정 완료 (2026-02-28)**
   - ~~긴급 청산 시 텔레그램 장애면 사용자 알림 불가~~
   - 수정: (1) `send_message()` 1회 재시도 추가 (2) 실패 시 `logs/emergency_alerts.log` 파일 폴백
   - 수정: (3) `send_emergency_alert()` 텔레그램 성공 여부와 무관하게 항상 파일 기록
   - 수정: (4) `SafetyGuard.emergency_liquidate()` 완료 후 `send_emergency_alert()` 자동 호출

### 중요 수정 권고 (운영 안정성)

3. **MDD 경고↔자동정지 미연결** (2.3-4)
   - danger(-6%)에서 경고만, 자동 진입 차단 미구현
   - 권고: MDDMonitor danger 시 STOP.signal 자동 생성

4. **데이터 백업 미흡** (4.2-5)
   - 1,029 parquet + 2,859 CSV가 로컬 디스크 단일본
   - 권고: 정기 외부 백업 (OneDrive/NAS/USB)

5. **데이터 피드 끊김 감지** (5.2-3)
   - 다수 종목 연속 0 응답 시 매매 중지 로직 없음
   - 권고: heartbeat 기반 피드 건강성 체크

### 보통 수정 권고 (개선 사항)

6. **프로세스 자동 재시작** (5.1-4): BAT에 재시도 루프 추가
7. **대량 주문 마켓 임팩트** (3.1-5): 현재 소규모라 당장 무관
8. **메모리 모니터링** (5.1-1): BAT 방식으로 리스크 경감
9. **증권사 점검시간** (5.2-4): BAT 스케줄이 자연 회피
10. **BAT 로그 로테이션** (5.1-3): schedule.log 무한 증가

---

## MEMORY.md 갱신 필요 사항

- v8 게이트 현재값: G1 ADX 18→**14**, G3 overheat 0.92→**0.95** (v8.5 역도출 반영)

---

## 최종 판정

- **실전 투입: 조건부 GO**
- **Critical 2건 수정 완료** (2026-02-28): 레짐 캡 연결, 텔레그램 폴백
- **잔여**: 중요 3건(MDD 연동, 백업, 피드 감지) + 보통 5건 — 운영 중 순차 개선 가능
- **권고**: dry_run 모드에서 1~2주 페이퍼 트레이딩 후 실전 전환
