# v10.3 ì½”ë“œ ê²€ìˆ˜ ì¼ì§€ (2026-02-18)

## ê²€ìˆ˜ ë²”ìœ„
- `src/signal_engine.py` (1,661 lines) â€” BES v3.1 Pipeline
- `src/v8_pipeline.py` (257 lines) â€” Gate+Score Hybrid
- `src/v8_triggers.py` (148 lines) â€” T1/T2/T3 íŠ¸ë¦¬ê±°
- `scripts/backtest_v2.py` (~800 lines) â€” v10.1 ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„
- `scripts/backtest_group_rotation.py` (~500 lines) â€” 3ì¸µ ìˆœí™˜ë§¤ ë°±í…ŒìŠ¤íŠ¸
- `scripts/blind_test_daily.py` (~540 lines) â€” ë¸”ë¼ì¸ë“œ í…ŒìŠ¤íŠ¸ ìžë™í™”
- `scripts/combine_strategies.py` (~270 lines) â€” ì „ëžµ ê²°í•© ì‹œë®¬ë ˆì´ì…˜
- `src/html_report.py` (~300 lines) â€” HTML ë³´ê³ ì„œ

---

## 1. ë¡œì§ ê²€ìˆ˜

### [ðŸ”´ C1] backtest_v2.py:482 â€” pnl_pct ë°˜ë§¤ë„ í˜¼í•© ê³„ì‚° ë¶€ì •í™•

**í˜„ìž¬ ì½”ë“œ:**
```python
pnl_pct = (sell_price / pos.buy_price - 1) if not pos.half_sold else (
    (pos.half_sold_pnl + (sell_price / pos.buy_price - 1)) / 2
)
```

**ë¬¸ì œ:** ë°˜ë§¤ë„ ì‹œ half_sold_pnlì€ `(sell_price / buy_price - 1)` = ìˆœìˆ˜ ê°€ê²© ë³€ë™ë¥ .
í•˜ì§€ë§Œ ë‚˜ë¨¸ì§€ ë°˜ì€ ë‹¤ë¥¸ ê°€ê²©ì— ì²­ì‚°ë˜ë¯€ë¡œ ë‹¨ìˆœ í‰ê· ì´ ì•„ë‹Œ ì£¼ìˆ˜ ê°€ì¤‘ í•„ìš”.
half_sold í›„ sharesê°€ ì ˆë°˜ìœ¼ë¡œ ì¤„ì—ˆëŠ”ë°, ì›ëž˜ half_sharesì™€ ë‚¨ì€ sharesê°€ ë‹¤ë¥¼ ìˆ˜ ìžˆìŒ
(í™€ìˆ˜ ì£¼ì¼ ë•Œ `shares // 2`ë¡œ ì¸í•´ ë¶ˆê· ë“±).

**ì˜í–¥:** PF/ìŠ¹ë¥ ì— ì†Œí­ ì™œê³¡ (ëŒ€ë¶€ë¶„ ê±°ëž˜ì—ì„œëŠ” ë¯¸ë¯¸í•˜ë‚˜, ì›ì¹™ì ìœ¼ë¡œ ë¶€ì •í™•)

**ìˆ˜ì • ì œì•ˆ:**
```python
# half_sold_pnlì„ ê¸ˆì•¡ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½
# ë˜ëŠ” half_shares/remaining_shares ë¹„ìœ¨ ê°€ì¤‘
```

**ìƒíƒœ:** v8.6ì—ì„œ ìˆ˜ìˆ˜ë£Œ ë°˜ì˜ì€ ìˆ˜ì •ë¨ (pnl_pct_net). ë°˜ë§¤ë„ ê°€ì¤‘ í˜¼í•©ì€ ë¯¸ìˆ˜ì •.

---

### [ðŸ”´ C2] backtest_v2.py:438 â€” ë°˜ë§¤ë„ day_pnl ì´ì¤‘ ê³„ì‚° ê°€ëŠ¥ì„±

**í˜„ìž¬ ì½”ë“œ:**
```python
# 1ì°¨ ìµì ˆ (ë°˜ë§¤ë„)
day_pnl += proceeds - half_shares * pos.buy_price
# ...
# ë‚˜ì¤‘ì— ì „ëŸ‰ ì²­ì‚° ì‹œ
pnl = proceeds - cost + (pos.half_sold_pnl * pos.allocated * 0.5 if pos.half_sold else 0)
day_pnl += pnl if mode != "A" else 0
```

**ë¬¸ì œ:** ë°˜ë§¤ë„ì˜ day_pnlê³¼ ì „ëŸ‰ ì²­ì‚°ì˜ day_pnlì´ ê°ê° ê³„ì‚°ë¨.
ë°˜ë§¤ë„ day_pnlì—ì„œ ì´ë¯¸ ì‹¤í˜„ëœ ìˆ˜ìµì´, ì „ëŸ‰ ì²­ì‚° ì‹œ `half_sold_pnl * allocated * 0.5`ë¡œ ë‹¤ì‹œ ê°€ì‚°.
ê°™ì€ ë‚  ë°˜ë§¤ë„+ì „ëŸ‰ì²­ì‚°ì´ ë™ì‹œì— ì¼ì–´ë‚˜ë©´ ì´ì¤‘ ê³„ì‚°.

**ì˜í–¥:** equity curveì˜ ì¼ì¼ PnL ì™œê³¡ â†’ MDD ê³„ì‚°ì— ê°„ì ‘ ì˜í–¥.
ì‹¤ì œë¡œëŠ” ê°™ì€ ë‚  ë™ì‹œ ë°œìƒì´ ë“œë¬¼ì–´ ì˜í–¥ ë¯¸ë¯¸.

**ìƒíƒœ:** ë¯¸ìˆ˜ì •

---

### [ðŸŸ¡ W1] signal_engine.py:920 â€” tc_cfg ì§ì ‘ ìˆ˜ì • (shared mutable state)

**í˜„ìž¬ ì½”ë“œ:**
```python
if news_score_boost >= 0.08:
    tc_cfg = self.triggers_cfg.get("trend_continuation", {})
    original_min = tc_cfg.get("min_conditions", 5)
    tc_cfg["min_conditions"] = max(original_min - 1, 3)
trend_cont = self.check_trend_continuation(df, idx)
if news_score_boost >= 0.08:
    tc_cfg["min_conditions"] = original_min
```

**ë¬¸ì œ:** `triggers_cfg`ì˜ `trend_continuation` ë”•ì…”ë„ˆë¦¬ë¥¼ ì§ì ‘ ìˆ˜ì • í›„ ì›ë³µ.
ë©€í‹°ìŠ¤ë ˆë”©ì´ë‚˜ ë™ì‹œ í˜¸ì¶œ ì‹œ race condition ê°€ëŠ¥.
í˜„ìž¬ ë‹¨ì¼ ìŠ¤ë ˆë“œë¼ ë¬¸ì œì—†ì§€ë§Œ, ì›ì¹™ì ìœ¼ë¡œ ìœ„í—˜.

**ì˜í–¥:** í˜„ìž¬ ë™ìž‘ì— ì˜í–¥ ì—†ìŒ. í–¥í›„ ë³‘ë ¬í™” ì‹œ ë²„ê·¸ ë°œìƒ ê°€ëŠ¥.

---

### [ðŸŸ¡ W2] v8_triggers.py:90 â€” T2 OR ì¡°ê±´ì´ ë„ˆë¬´ í—ˆìš©ì 

**í˜„ìž¬ ì½”ë“œ:**
```python
fired = vol_surge or rsi_in_range
```

**ë¬¸ì œ:** RSIê°€ 35~55 ë²”ìœ„ì´ê¸°ë§Œ í•˜ë©´ ê±°ëž˜ëŸ‰ ì¡°ê±´ ì—†ì´ë„ íŠ¸ë¦¬ê±° ë°œë™.
ëŒ€ë¶€ë¶„ì˜ ì¢…ëª©ì´ RSI 35~55 ë²”ìœ„ì— ìžˆì„ ìˆ˜ ìžˆì–´ íŠ¸ë¦¬ê±°ê°€ ê±°ì˜ í•­ìƒ ë°œë™.

**ì˜í–¥:** ë°±í…ŒìŠ¤íŠ¸ v8 ì›ë³µ ì„¤ì •ì—ì„œ ê²€ì¦ë¨ (PF 1.50). í˜„ íŒŒë¼ë¯¸í„°ì—ì„œëŠ” Gateê°€ ì¶©ë¶„ížˆ
í•„í„°ë§í•˜ë¯€ë¡œ ì‹¤ì§ˆ ë¬¸ì œëŠ” ì—†ìœ¼ë‚˜, êµ¬ì¡°ì ìœ¼ë¡œ T2ì˜ ë…ë¦½ í•„í„°ë§ ëŠ¥ë ¥ì´ ì•½í•¨.

**ìƒíƒœ:** ê¸°ì¡´ ì•Œë ¤ì§„ ì´ìŠˆ (v8.6 ê²€ìˆ˜ Warning). í˜„ìž¬ ìˆ˜ì¹˜ì—ì„œëŠ” í—ˆìš©.

---

### [ðŸŸ¡ W3] backtest_v2.py:390 â€” ë‚ ì§œ ì¸ë±ìŠ¤ pad ë°©ì‹ ê³µìœ  ë¬¸ì œ

**í˜„ìž¬ ì½”ë“œ:**
```python
loc = df.index.get_indexer([date], method="pad")
if loc[0] >= 0:
    ad = df.index[loc[0]]
    if abs((ad - date).days) <= 3:
        day_idx_map[ticker] = loc[0]
```

**ë¬¸ì œ:** ì¢…ëª©ë§ˆë‹¤ ê±°ëž˜ì¼ì´ ë‹¤ë¥¼ ìˆ˜ ìžˆìŒ (ìƒìž¥íì§€, ê±°ëž˜ì •ì§€ ë“±).
pad ë°©ì‹ìœ¼ë¡œ 3ì¼ê¹Œì§€ í—ˆìš©í•˜ë¯€ë¡œ, ì‹¤ì œë¡œëŠ” ê¸ˆìš”ì¼ ë°ì´í„°ë¥¼ ì›”ìš”ì¼ì— ì‚¬ìš© ê°€ëŠ¥.
ë¬¸ì œëŠ” ì´ ì¢…ëª©ì˜ ì‹œê·¸ë„ì´ "ë‹¹ì¼" ê¸°ì¤€ì´ ì•„ë‹Œ "ìµœëŒ€ 3ì¼ ì „" ê¸°ì¤€ì´ ë  ìˆ˜ ìžˆìŒ.

**ì˜í–¥:** 101ì¢…ëª© ì¤‘ ëŒ€ë¶€ë¶„ì€ ë™ì¼ ê±°ëž˜ì¼. ë¹„ì •ìƒ ì¢…ëª©ì—ì„œë§Œ ë°œìƒí•˜ë©° í™•ë¥  ë‚®ìŒ.

---

### [ðŸŸ¡ W4] backtest_v2.py:549-554 â€” ì‹œê·¸ë„ì¼ ë‹¤ìŒë‚  ì‹œê°€ ë§¤ìˆ˜ (ì˜¬ë°”ë¦„) but ìŠ¬ë¦¬í”¼ì§€ ë°©í–¥

**í˜„ìž¬ ì½”ë“œ:**
```python
next_open = float(df.iloc[idx + 1]["open"])
buy_price = next_open * (1 + SLIPPAGE)
```

**í™•ì¸:** ì‹œê·¸ë„ tì¼ â†’ t+1 ì‹œê°€ ë§¤ìˆ˜ â†’ look-ahead bias ì—†ìŒ. **ì •ìƒ**
ìŠ¬ë¦¬í”¼ì§€ 0.5% ìƒí–¥ ì ìš© â†’ **ì •ìƒ** (ë¶ˆë¦¬í•œ ë°©í–¥)

---

### [ðŸŸ¡ W5] backtest_group_rotation.py:420 â€” z_data ì—†ì„ ë•Œ stock_close ëŒ€ì²´

**í˜„ìž¬ ì½”ë“œ:**
```python
stock_close = z_data["close"] if z_data else pos.buy_price
```

**ë¬¸ì œ:** z_dataê°€ ì—†ì„ ë•Œ (ì¢…ëª© ë°ì´í„° gap) buy_priceë¥¼ ì‚¬ìš©.
ì´ë ‡ê²Œ í•˜ë©´ ì†ì ˆ/ìµì ˆ íŒì •ì´ ë§¤ìˆ˜ê°€ ê¸°ì¤€ì´ë¼ í•­ìƒ PnL=0.
ì¢…ëª©ì´ ì‹¤ì œë¡œëŠ” í¬ê²Œ ì›€ì§ì˜€ì„ ìˆ˜ ìžˆìŒ.

**ì˜í–¥:** ë°ì´í„° gap ë°œìƒ ì‹œ (ë§¤ìš° ë“œë¬¸ ê²½ìš°) ì˜¤íŒ ê°€ëŠ¥.

**ìˆ˜ì • ì œì•ˆ:** parquetì—ì„œ ì§ì ‘ í•´ë‹¹ ë‚ ì§œ closeë¥¼ ê°€ì ¸ì˜¤ëŠ” fallback ì¶”ê°€.

---

### [ðŸŸ¡ W6] blind_test_daily.py:81 â€” get_kospi_regime()ì´ "ì˜¤ëŠ˜" ë°ì´í„° ì‚¬ìš©

**í˜„ìž¬ ì½”ë“œ:**
```python
row = df.iloc[-1]  # ìµœì‹  ë°ì´í„°
```

**vs backtest_v2.py:**
```python
prev = kospi_df[kospi_df.index < date]  # ì „ì¼ ë°ì´í„°
```

**ë¬¸ì œ:** ë¸”ë¼ì¸ë“œ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ë‹¹ì¼ ìž¥ë§ˆê° í›„ ì‹¤í–‰í•˜ë¯€ë¡œ `df.iloc[-1]`ì´ "ì˜¤ëŠ˜".
ë°±í…ŒìŠ¤íŠ¸ì—ì„œëŠ” `< date`ë¡œ ì „ì¼ ë°ì´í„° ì‚¬ìš©.
ë¸”ë¼ì¸ë“œ í…ŒìŠ¤íŠ¸ê°€ ìž¥ë§ˆê° í›„ ì‹¤í–‰ë˜ë©´ ì´ëŠ” **ì˜ë„ëœ ë™ìž‘** (ë‹¹ì¼ ì¢…ê°€ ë°˜ì˜).
ë‹¨, ìž¥ì¤‘ì— ì‹¤í–‰í•˜ë©´ ì „ì¼ ì¢…ê°€ ê¸°ì¤€ì´ ë¨ â†’ ì¼ê´€ì„± ì´ìŠˆ.

**ì˜í–¥:** ì‚¬ìš© ì‹œì ì— ë”°ë¼ ë ˆì§ íŒì •ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìžˆìŒ. ìž¥ë§ˆê° í›„ ì‚¬ìš© ì‹œ ì •ìƒ.

---

## 2. ë°ì´í„° ë¬´ê²°ì„±

### [ðŸŸ¢ M1] signal_engine.py:231-245 â€” atr_pullback NaN ì²˜ë¦¬ ì–‘í˜¸

`pd.isna(pullback_atr) or pullback_atr < 0` â†’ 0.0 ë°˜í™˜. **ì •ìƒ**

### [ðŸŸ¢ M2] v8_triggers.py:48-51 â€” TRIX NaN ì‹œ ê¸°ë³¸ê°’ 0

`row.get('trix', 0)` â†’ NaNì´ ì•„ë‹Œ 0 ê¸°ë³¸ê°’. **ì •ìƒ**

### [ðŸŸ¢ M3] backtest_group_rotation.py:245-248 â€” std ë³´í˜¸

`if std_20 < 0.01: std_20 = 1.0` â†’ 0 ë‚˜ëˆ„ê¸° ë°©ì§€. **ì •ìƒ**

---

## 3. ê³„ì‚° ì •í™•ì„±

### [ðŸŸ¢ M4] backtest_v2.py:294-296 â€” ATR ê°„ì´ ê³„ì‚°

```python
atr_arr = df["high"].values - df["low"].values
atr = np.mean(atr_arr[max(0, idx - 13):idx + 1])
```

**í™•ì¸:** True Rangeê°€ ì•„ë‹Œ High-Lowë§Œ ì‚¬ìš©. ê°­ ê³ ë ¤ ì•ˆí•¨.
ê·¸ëŸ¬ë‚˜ v10.1 ì‹œê·¸ë„ì—ì„œëŠ” ê°„ì´ ATRì´ ì ì ˆ (TRIX ê¸°ë°˜ì´ë¼ ì •ë°€ ATR ë¶ˆí•„ìš”).
**í—ˆìš© ë²”ìœ„ ë‚´.**

### [ðŸŸ¢ M5] backtest_v2.py:622 â€” ë¯¸ì²­ì‚° í¬ì§€ì…˜ ê°•ì œ ì²­ì‚°ì˜ ìˆ˜ìˆ˜ë£Œ ë°˜ì˜

```python
pnl_pct = (last_close / pos.buy_price - 1) - COMMISSION * 2 - TAX
```
**ì •ìƒ.** ìˆ˜ìˆ˜ë£Œ+ì„¸ê¸ˆ ì°¨ê°ë¨.

### [ðŸŸ¢ M6] backtest_group_rotation.py:429 â€” ìˆœí™˜ë§¤ ìˆ˜ìˆ˜ë£Œ ë°˜ì˜

```python
pnl_pct = (sell_price / pos.buy_price - 1) - COMMISSION * 2 - TAX
```
**ì •ìƒ.**

### [ðŸŸ¢ M7] v8_pipeline.py:358 â€” Zone Score 0~1 ë²”ìœ„ ë³´ìž¥

zone_scoreëŠ” `ScoringEngine.score_all()`ì—ì„œ ê³„ì‚°.
signal_engine.py:358ì—ì„œ `min(max(..., 0.0), 1.0)` í´ë¦¬í•‘. **ì •ìƒ.**

---

## 4. ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„ ê²€ìˆ˜

### [ðŸŸ¢ M8] Look-ahead bias ì ê²€

| í•­ëª© | ê²°ê³¼ |
|------|------|
| ë§¤ìˆ˜ íƒ€ì´ë° | tì¼ ì‹œê·¸ë„ â†’ t+1 ì‹œê°€ ë§¤ìˆ˜ âœ“ |
| ë§¤ë„ íƒ€ì´ë° | ìž¥ì¤‘ high/low ì²´í¬ â†’ ë‹¹ì¼ ë°˜ì˜ (í˜„ì‹¤ì ) âœ“ |
| KOSPI ë ˆì§ | `kospi_df.index < date` (ì „ì¼ ê¸°ì¤€) âœ“ |
| EWY í•„í„° | `get_etf_state()` pad ë°©ì‹ (ì „ì¼ ì´ì „) âœ“ |
| Z-score | ë‹¹ì¼ ë°ì´í„°ë¡œ ê³„ì‚° (ìž¥ì¤‘ íŒë‹¨) âœ“ |

### [ðŸŸ¢ M9] ì¤‘ë³µ ì§„ìž… ë°©ì§€

```python
if sig["ticker"] in held_tickers:
    continue
```
**ì •ìƒ.** v10.1 ë°±í…ŒìŠ¤íŠ¸ì™€ ìˆœí™˜ë§¤ ë°±í…ŒìŠ¤íŠ¸ ëª¨ë‘ ë³´ìœ  ì¢…ëª© ì§„ìž… ì°¨ë‹¨.

### [ðŸŸ¢ M10] í¬ì§€ì…˜ ì‚¬ì´ì§• ìƒí•œ

- v10.1: `MAX_POSITIONS = 5`, `MAX_DAILY_ENTRY = 2` âœ“
- ìˆœí™˜ë§¤: `MAX_POSITIONS = 3`, `MAX_PER_GROUP = 2` âœ“
- `available_slots = max_slots - len(positions)` â†’ ì´ˆê³¼ ë¶ˆê°€ âœ“

### [ðŸŸ¢ M11] MDD ê³„ì‚°

```python
eq_arr = np.array(equities)
peak = np.maximum.accumulate(eq_arr)
dd_pct = (eq_arr - peak) / peak * 100
mdd = np.min(dd_pct)
```
**ì •ìƒ.** ëˆ„ì  ìµœê³ ì  ëŒ€ë¹„ í•˜ë½ë¥  ë°©ì‹.

---

## 5. ì¶œë ¥ ê²°ê³¼ ê²€ì¦

### [ðŸŸ¢ M12] HTML ë³´ê³ ì„œ â€” v9 ê°ì§€ ë¡œì§

```python
is_v9 = candidates and "v9_rank_score" in candidates[0]
```
v9 í‚¤ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ v8 HTML ì‚¬ìš©. **ì •ìƒ.**

### [ðŸŸ¢ M13] ë¸”ë¼ì¸ë“œ í…ŒìŠ¤íŠ¸ z-score â†” ë°±í…ŒìŠ¤íŠ¸ ì¼ì¹˜ í™•ì¸

blind_test_daily.pyì˜ `scan_rotation()`ê³¼ backtest_group_rotation.pyì˜
`calc_group_z_scores()`ë¥¼ ë¹„êµ:
- ë™ì¼ ê³µì‹: `z_20 = (rel_ret_20 - mean_20) / std_20`
- ë™ì¼ std ë³´í˜¸: `max(std, 0.01)`
- ë™ì¼ ì§„ìž… ì¡°ê±´: z_20 < -0.8, rel_ret_20 < -3%, ë°˜ì „ í™•ì¸, MA60 ìœ„

**ì¼ì¹˜ í™•ì¸.** ë¼ì´ë¸Œ ìŠ¤ìº” ê²°ê³¼ì™€ ë°±í…ŒìŠ¤íŠ¸ íŒë‹¨ì´ ë™ì¼.

---

## ìš”ì•½

| ì‹¬ê°ë„ | ê±´ìˆ˜ | í•­ëª© |
|--------|------|------|
| ðŸ”´ Critical | 2 | C1 (ë°˜ë§¤ë„ PnL ê°€ì¤‘), C2 (ë°˜ë§¤ë„ ì´ì¤‘ê³„ì‚°) |
| ðŸŸ¡ Warning | 6 | W1~W6 |
| ðŸŸ¢ Minor | 13 | M1~M13 |

### Critical í‰ê°€
- **C1, C2 ëª¨ë‘ Dëª¨ë“œ(ë°˜ë§¤ë„ ìµì ˆ) ì „ìš©.** C_new ëª¨ë“œì—ì„œëŠ” ë°˜ë§¤ë„ ì—†ìœ¼ë¯€ë¡œ ì˜í–¥ ì—†ìŒ.
- í˜„ìž¬ ìš´ìš© ëª¨ë“œëŠ” **C_new** (KOSPI ë ˆì§ ìº¡) â†’ **C1/C2 ì˜í–¥ ì—†ìŒ**.
- Dëª¨ë“œë¥¼ ì‚¬ìš©í•  ê²½ìš°ì—ë§Œ ìˆ˜ì • í•„ìš”.

### ì´ì „ ê²€ìˆ˜ ëŒ€ë¹„ ë³€ê²½
- v8.6 C1 (pnl_pct ìˆ˜ìˆ˜ë£Œ): âœ… ìˆ˜ì • ì™„ë£Œ í™•ì¸
- v8.6 GPT/OpenAI ì œê±°: âœ… í™•ì¸
- ì‹ ê·œ íŒŒì¼ (blind_test_daily.py, combine_strategies.py, backtest_group_rotation.py):
  **ì‹ ê·œ ê²€ìˆ˜ ì™„ë£Œ. Critical ì´ìŠˆ ì—†ìŒ.**

### ê²°ë¡ 
**í˜„ìž¬ ìš´ìš© ì½”ë“œ(C_new ëª¨ë“œ + ìˆœí™˜ë§¤ Dëª¨ë“œ)ì— Critical ì´ìŠˆ ì—†ìŒ.**
Dëª¨ë“œ ë°˜ë§¤ë„ ë¡œì§ ê°œì„ ì€ í–¥í›„ ê³¼ì œë¡œ ë‚¨ê¹€.
