# Plan: 주식분석 서브에이전트

## 1. 개요

| 항목 | 내용 |
|------|------|
| 기능명 | 주식분석 서브에이전트 시스템 |
| 우선순위 | P0 (핵심 기능) |
| 예상 규모 | Major Feature |
| 프로젝트 레벨 | Dynamic |

## 2. 배경 및 목적

한국 주식시장의 기술적 분석을 자동화하기 위한 AI 서브에이전트 시스템을 구축한다.
클린 아키텍처 기반으로 5개의 전문 서브에이전트가 협업하여 종합 분석 리포트를 생성한다.

### 해결하려는 문제
- 수동 차트 분석의 비효율성
- 여러 기술지표를 종합적으로 판단하는 데 드는 시간과 노력
- 감정에 의한 투자 판단 오류 최소화

## 3. 핵심 요구사항

### 3.1 서브에이전트 구성 (5개)

| 에이전트 | 역할 | 계층 |
|---------|------|------|
| 📊 차트분석 (ChartAnalysisAgent) | 기술적 패턴/지표 분석 (RSI, MACD, 볼린저밴드) | Adapters |
| 📈 거래량분석 (VolumeAnalysisAgent) | 거래량 & 매물대 분석, 매집/분산 판단 | Adapters |
| 🔮 흐름예측 (FlowPredictionAgent) | 내일 흐름 종합 예측, 방향/확신도/가격범위 | Adapters |
| ⚖️ 조건판단 (ConditionJudgeAgent) | 유지조건/대응조건 생성 | Adapters |
| 🎯 오케스트레이터 (OrchestratorAgent) | 전체 워크플로우 조율, 데이터 수집, 리포트 출력 | Adapters |

### 3.2 클린 아키텍처 계층

| 계층 | 구성 요소 | 파일 경로 |
|------|----------|----------|
| Entities | Stock, ChartData, TechnicalPattern, SupplyDemandZone, Condition, FlowPrediction | `src/entities/models.py` |
| Use Cases | StockAnalysisInteractor, Ports(인터페이스) | `src/use_cases/stock_analysis.py`, `src/use_cases/ports.py` |
| Adapters | 5개 서브에이전트, MarkdownPresenter | `src/agents/*.py`, `src/adapters/*.py` |
| Frameworks | Claude API, 한국투자증권 API(mojito2), 웹 스크래핑 | 외부 라이브러리 |

### 3.3 워크플로우 (6단계)

```
1. 데이터 수집 (오케스트레이터) → 차트 + 이슈 수집
2. 패턴 분석 (차트분석) → 캔들, 이평선, RSI, MACD
3. 거래량 분석 (거래량분석) → 매물대, 매집/분산
4. 흐름 예측 (흐름예측) → 내일 방향 + 가격 범위
5. 조건 판단 (조건판단) → 유지조건 / 대응조건
6. 리포트 출력 (오케스트레이터) → 마크다운 리포트
```

### 3.4 출력 리포트 구조

1. 업체 정보 (종목코드, 종목명, 시장, 업종)
2. 기술적 형태/지표 (캔들 패턴, 이평선, RSI, MACD, 볼린저, 스토캐스틱)
3. 거래량 분석 (거래량 비율, 추세, 매집/분산 신호)
4. 핵심 분석 포인트 (중요도별 정렬)
5. 매물대 분석 (지지대/저항대 가격 구간, 강도)
6. 최근 이슈 (뉴스, 감성 분석)
7. 내일 흐름 예측 (방향, 확신도, 예상 가격 범위, 핵심 요인)
8. 유지/대응 조건 (✅ 유지조건, 🚨 대응조건)

## 4. 기술 스택

| 구분 | 기술 |
|------|------|
| 언어 | Python 3.13 + asyncio |
| AI API | Anthropic Claude API |
| 증권 API | 한국투자증권 API (mojito2) |
| 설정 관리 | python-dotenv (.env) |
| 아키텍처 | 클린 아키텍처 (4계층) |

## 5. 의존성 규칙

- **Entities**: 외부 의존 없는 순수 비즈니스 객체
- **Use Cases**: Entities만 참조, Port(인터페이스)로 외부와 소통
- **Adapters**: Use Cases + Entities 참조, Port 구현
- **Frameworks**: 모든 계층 참조 가능, 교체 용이

```
의존성 방향: Frameworks → Adapters → Use Cases → Entities
                (바깥)                              (안쪽)
```

## 6. 구현 순서 (제안)

1. **Phase 1**: Entities 정의 (`src/entities/models.py`)
2. **Phase 2**: Ports 인터페이스 정의 (`src/use_cases/ports.py`)
3. **Phase 3**: Use Cases 구현 (`src/use_cases/stock_analysis.py`)
4. **Phase 4**: 개별 서브에이전트 구현 (`src/agents/*.py`)
5. **Phase 5**: 오케스트레이터 구현 (`src/agents/orchestrator.py`)
6. **Phase 6**: 어댑터/프레젠터 구현 (`src/adapters/*.py`)
7. **Phase 7**: 통합 테스트 및 리포트 검증

## 7. 위험 요소 및 대응

| 위험 요소 | 대응 방안 |
|----------|----------|
| Claude API 호출 비용 증가 | 캐싱, 프롬프트 최적화 |
| 한국투자증권 API 제한 | Rate limiting, 데이터 캐싱 |
| 에이전트 간 데이터 불일치 | Entity 객체로 표준화 |
| 분석 정확도 검증 어려움 | 백테스팅, 과거 데이터 비교 |

## 8. 주의사항

- 이 시스템은 투자 참고 정보만 제공하며, 투자 판단의 책임은 사용자에게 있음
- API 키는 `.env` 파일에서 관리하며 절대 코드에 포함하지 않음
- 모든 에이전트 간 통신은 Port(인터페이스)를 통해 수행
